"""Check dependencies against vulnerability databases."""

import requests
from typing import List, Dict
from packaging.version import parse as parse_version

from ..core.models import Dependency, Vulnerability


class VulnerabilityChecker:
    """Checks dependencies for known vulnerabilities."""

    def __init__(self):
        # In a real implementation, this would query PyPI or OSV API
        # For this demo, we'll use a mock database
        self.vuln_db = {
            "tensorflow": [
                {
                    "id": "CVE-2023-12345",
                    "affected": "<2.12.0",
                    "fixed": "2.12.0",
                    "severity": "high",
                    "description": "Buffer overflow in TensorFlow",
                }
            ],
            "protobuf": [
                {
                    "id": "CVE-2022-54321",
                    "affected": "<3.20.0",
                    "fixed": "3.20.0",
                    "severity": "medium",
                    "description": "DoS vulnerability in Protobuf",
                }
            ]
        }

    def check_vulnerabilities(self, dependencies: List[Dependency]) -> List[Vulnerability]:
        """Check a list of dependencies for vulnerabilities."""
        vulnerabilities = []
        
        for dep in dependencies:
            if not dep.version:
                continue
                
            if dep.name in self.vuln_db:
                for vuln_info in self.vuln_db[dep.name]:
                    if self._is_affected(dep.version, vuln_info["affected"]):
                        vulnerabilities.append(
                            Vulnerability(
                                package_name=dep.name,
                                current_version=dep.version,
                                vuln_id=vuln_info["id"],
                                description=vuln_info["description"],
                                severity=vuln_info["severity"],
                                fixed_in=[vuln_info["fixed"]],
                                advisory_url=f"https://osv.dev/vulnerability/{vuln_info['id']}"
                            )
                        )
                        
        return vulnerabilities

    def _is_affected(self, current_version: str, constraint: str) -> bool:
        """Check if version matches constraint (simplified)."""
        try:
            current = parse_version(current_version)
            
            if constraint.startswith("<"):
                limit = parse_version(constraint[1:])
                return current < limit
            elif constraint.startswith("<="):
                limit = parse_version(constraint[2:])
                return current <= limit
                
            return False
        except Exception:
            return False
